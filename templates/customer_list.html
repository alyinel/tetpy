{% extends "base.html" %}

{% block content %}
    <div class="row mb-3">
        <div class="col-md-8">
            <h2>Aktif Müşteri Listesi</h2>
        </div>
        <div class="col-md-4 text-end">
            {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <a href="{{ url_for('add_customer') }}" class="btn btn-primary me-2">+ Yeni Müşteri Ekle</a>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Dışa Aktar
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('export_excel') }}">Excel</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('export_pdf') }}">PDF</a></li>
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="mb-3">
        <input type="text" id="search-input" onkeyup="filterTable()" class="form-control" placeholder="İsim, Telefon veya Adres Ara...">
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover customer-table">
            <thead>
                <tr>
                    <th>Müşteri Adı</th>
                    <th>Telefon</th>
                    <th>Adres</th>
                    <th>İş Türü</th>
                    <th>Durum</th>
                    <th>Tarih</th>
                    <th>Not</th>
                    {% if current_user.is_authenticated and current_user.role == 'admin' %}
                        <th>Eylemler</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr>
                    <td>{{ customer.name }}</td>
                    <td>{{ customer.phone }}</td>
                    <td>{{ customer.address }}</td>
                    <td>{{ customer.job_type }}</td>
                    <td>
                        {% if current_user.is_authenticated and current_user.role == 'admin' %}
                            <form action="{{ url_for('update_customer_status', customer_id=customer.id) }}" method="POST" class="d-inline">
                                <select name="status" onchange="this.form.submit()" class="form-select form-select-sm status-{{ customer.status.lower() }}">
                                    <option value="Beklemede" {% if customer.status == 'Beklemede' %}selected{% endif %}>Beklemede</option>
                                    <option value="Devam Ediyor" {% if customer.status == 'Devam Ediyor' %}selected{% endif %}>Devam Ediyor</option>
                                    <option value="Tamamlandı" {% if customer.status == 'Tamamlandı' %}selected{% endif %}>Tamamlandı</option>
                                </select>
                            </form>
                        {% else %}
                            <span class="badge bg-{{ {'beklemede': 'secondary', 'devam ediyor': 'warning', 'tamamlandı': 'success'}[customer.status.lower()] }}">{{ customer.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ customer.date }}</td>
                    <td>{{ customer.note }}</td>
                    {% if current_user.is_authenticated and current_user.role == 'admin' %}
                        <td>
                            <a href="{{ url_for('edit_customer', customer_id=customer.id) }}" class="btn btn-sm btn-info me-1">Düzenle</a>
                            <form action="{{ url_for('delete_customer', customer_id=customer.id) }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger">Sil</button>
                            </form>
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        function filterTable() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("search-input");
            filter = input.value.toUpperCase();
            table = document.querySelector(".customer-table");
            tr = table.getElementsByTagName("tr");

            for (i = 0; i < tr.length; i++) {
                // Skip table headers
                if (i === 0) continue;

                var found = false;
                // Sütun indekslerini müşteri adına, telefonuna ve adresine göre ayarlayın
                // Bu indeksler, Customer modelindeki sıralamaya göre değişebilir
                var nameCol = 0; // Müşteri Adı
                var phoneCol = 1; // Telefon
                var addressCol = 2; // Adres

                td = tr[i].getElementsByTagName("td")[nameCol];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                    }
                }
                td = tr[i].getElementsByTagName("td")[phoneCol];
                if (td && !found) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                    }
                }
                td = tr[i].getElementsByTagName("td")[addressCol];
                if (td && !found) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                    }
                }

                if (found) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    </script>
{% endblock %}
